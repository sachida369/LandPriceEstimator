{% extends "base.html" %}

{% block title %}Data Management - Admin{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h1 class="display-6">
                    <i class="fas fa-database text-primary me-3"></i>
                    Data Management
                </h1>
                <div>
                    <a href="{{ url_for('auth.dashboard') }}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
                    </a>
                </div>
            </div>
        </div>
    </div>
    
    <!-- CSV Upload Section -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h4 class="card-title mb-0">
                        <i class="fas fa-upload me-2"></i>Upload CSV Data
                    </h4>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('auth.upload_csv') }}" enctype="multipart/form-data">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="data_type" class="form-label">Data Type</label>
                                    <select class="form-select" id="data_type" name="data_type" required>
                                        <option value="">Select Data Type</option>
                                        <option value="cities">Cities</option>
                                        <option value="localities">Localities</option>
                                        <option value="multipliers">Infrastructure Multipliers</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="file" class="form-label">CSV File</label>
                                    <input type="file" class="form-control" id="file" name="file" accept=".csv" required>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">&nbsp;</label>
                                    <div class="d-grid">
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fas fa-upload me-2"></i>Upload
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                    
                    <!-- CSV Format Guidelines -->
                    <div class="mt-4">
                        <div class="accordion" id="csvFormatAccordion">
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#csvFormats">
                                        <i class="fas fa-info-circle me-2"></i>CSV Format Guidelines
                                    </button>
                                </h2>
                                <div id="csvFormats" class="accordion-collapse collapse" data-bs-parent="#csvFormatAccordion">
                                    <div class="accordion-body">
                                        <div class="row">
                                            <div class="col-md-4">
                                                <h6>Cities CSV Format:</h6>
                                                <code>name,state,base_price_per_sqft,growth_rate,population,tier</code>
                                            </div>
                                            <div class="col-md-4">
                                                <h6>Localities CSV Format:</h6>
                                                <code>name,city_name,state,price_per_sqft,location_multiplier,area_type,pin_code</code>
                                            </div>
                                            <div class="col-md-4">
                                                <h6>Multipliers CSV Format:</h6>
                                                <code>factor_type,factor_value,multiplier,description</code>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Data Export Section -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h4 class="card-title mb-0">
                        <i class="fas fa-download me-2"></i>Export Data
                    </h4>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4 text-center mb-3">
                            <a href="{{ url_for('auth.export_data', data_type='cities') }}" class="btn btn-outline-primary btn-lg w-100">
                                <i class="fas fa-city fa-2x d-block mb-2"></i>
                                Export Cities
                            </a>
                        </div>
                        <div class="col-md-4 text-center mb-3">
                            <a href="{{ url_for('auth.export_data', data_type='localities') }}" class="btn btn-outline-success btn-lg w-100">
                                <i class="fas fa-map-marker-alt fa-2x d-block mb-2"></i>
                                Export Localities
                            </a>
                        </div>
                        <div class="col-md-4 text-center mb-3">
                            <a href="{{ url_for('auth.export_data', data_type='estimates') }}" class="btn btn-outline-info btn-lg w-100">
                                <i class="fas fa-calculator fa-2x d-block mb-2"></i>
                                Export Estimates
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Cities Management -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h4 class="card-title mb-0">
                        <i class="fas fa-city me-2"></i>Cities Management
                    </h4>
                </div>
                <div class="card-body">
                    {% if cities %}
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>City</th>
                                    <th>State</th>
                                    <th>Base Price (₹/sq ft)</th>
                                    <th>Growth Rate</th>
                                    <th>Tier</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for city in cities[:10] %}
                                <tr>
                                    <td><strong>{{ city.name }}</strong></td>
                                    <td>{{ city.state }}</td>
                                    <td>₹{{ city.base_price_per_sqft|round }}</td>
                                    <td>{{ (city.growth_rate * 100)|round(1) }}%</td>
                                    <td>
                                        <span class="badge bg-{{ 'primary' if city.tier == 'Tier 1' else 'secondary' if city.tier == 'Tier 2' else 'info' }}">
                                            {{ city.tier or 'N/A' }}
                                        </span>
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary" onclick="editCity({{ city.id }}, '{{ city.name }}', {{ city.base_price_per_sqft }}, {{ city.growth_rate }})">
                                            <i class="fas fa-edit"></i> Edit
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% if cities|length > 10 %}
                    <div class="text-center">
                        <small class="text-muted">Showing first 10 cities of {{ cities|length }} total</small>
                    </div>
                    {% endif %}
                    {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-city fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">No cities data available</h5>
                        <p class="text-muted">Upload a cities CSV file to get started</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Infrastructure Multipliers -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h4 class="card-title mb-0">
                        <i class="fas fa-road me-2"></i>Infrastructure Multipliers
                    </h4>
                </div>
                <div class="card-body">
                    {% if multipliers %}
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Factor Type</th>
                                    <th>Factor Value</th>
                                    <th>Multiplier</th>
                                    <th>Description</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for multiplier in multipliers %}
                                <tr>
                                    <td><span class="badge bg-primary">{{ multiplier.factor_type }}</span></td>
                                    <td><strong>{{ multiplier.factor_value }}</strong></td>
                                    <td>
                                        <span class="text-{{ 'success' if multiplier.multiplier > 1 else 'danger' if multiplier.multiplier < 1 else 'secondary' }}">
                                            {{ multiplier.multiplier }}x
                                        </span>
                                    </td>
                                    <td><small class="text-muted">{{ multiplier.description or 'No description' }}</small></td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-road fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">No multipliers data available</h5>
                        <p class="text-muted">Upload a multipliers CSV file to configure infrastructure factors</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- API Keys Management -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h4 class="card-title mb-0">
                        <i class="fas fa-key me-2"></i>API Keys Management
                    </h4>
                    <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#createApiKeyModal">
                        <i class="fas fa-plus me-2"></i>Create New API Key
                    </button>
                </div>
                <div class="card-body">
                    {% if api_keys %}
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>API Key</th>
                                    <th>Rate Limit</th>
                                    <th>Status</th>
                                    <th>Last Used</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for key in api_keys %}
                                <tr>
                                    <td><strong>{{ key.name }}</strong></td>
                                    <td>
                                        <code class="api-key-display">{{ key.key[:20] }}...</code>
                                        <button class="btn btn-sm btn-outline-secondary ms-2" onclick="copyToClipboard('{{ key.key }}')">
                                            <i class="fas fa-copy"></i>
                                        </button>
                                    </td>
                                    <td>{{ key.rate_limit }}/hour</td>
                                    <td>
                                        <span class="badge bg-{{ 'success' if key.is_active else 'danger' }}">
                                            {{ 'Active' if key.is_active else 'Inactive' }}
                                        </span>
                                    </td>
                                    <td>
                                        {% if key.last_used %}
                                        <small class="text-muted">{{ key.last_used.strftime('%Y-%m-%d %H:%M') }}</small>
                                        {% else %}
                                        <small class="text-muted">Never</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <a href="{{ url_for('auth.toggle_api_key', key_id=key.id) }}" 
                                           class="btn btn-sm btn-outline-{{ 'danger' if key.is_active else 'success' }}">
                                            <i class="fas fa-{{ 'pause' if key.is_active else 'play' }}"></i>
                                            {{ 'Deactivate' if key.is_active else 'Activate' }}
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-key fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">No API keys created</h5>
                        <p class="text-muted">Create API keys to allow external access to the estimation service</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit City Modal -->
<div class="modal fade" id="editCityModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit City</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('auth.update_city') }}">
                <div class="modal-body">
                    <input type="hidden" id="editCityId" name="city_id">
                    <div class="mb-3">
                        <label class="form-label">City Name</label>
                        <input type="text" class="form-control" id="editCityName" readonly>
                    </div>
                    <div class="mb-3">
                        <label for="editBasePrice" class="form-label">Base Price per sq ft (₹)</label>
                        <input type="number" class="form-control" id="editBasePrice" name="base_price" required>
                    </div>
                    <div class="mb-3">
                        <label for="editGrowthRate" class="form-label">Growth Rate (decimal)</label>
                        <input type="number" class="form-control" id="editGrowthRate" name="growth_rate" step="0.01" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update City</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Create API Key Modal -->
<div class="modal fade" id="createApiKeyModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create New API Key</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('auth.create_api_key') }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="apiKeyName" class="form-label">API Key Name</label>
                        <input type="text" class="form-control" id="apiKeyName" name="name" required>
                        <div class="form-text">Give a descriptive name for this API key</div>
                    </div>
                    <div class="mb-3">
                        <label for="apiKeyRateLimit" class="form-label">Rate Limit (requests per hour)</label>
                        <input type="number" class="form-control" id="apiKeyRateLimit" name="rate_limit" value="50" min="1" max="1000">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create API Key</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/admin.js') }}"></script>
{% endblock %}
